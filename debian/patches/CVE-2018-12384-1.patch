Backport of:

# HG changeset patch
# User Martin Thomson <mt@mozilla.com>
# Date 1535720767 -7200
# Node ID 46f9a1f40c3dd53cf4627e007429530fe989f592
# Parent  93108979390d163ae97d73db5a2df883d2bf8c62
Bug 1483128, backported fix for CVE-2018-12384 to the NSS_3_36_BRANCH

Index: nss-3.28.4/nss/lib/ssl/ssl3con.c
===================================================================
--- nss-3.28.4.orig/nss/lib/ssl/ssl3con.c	2018-12-14 09:48:09.000000000 -0500
+++ nss-3.28.4/nss/lib/ssl/ssl3con.c	2018-12-14 09:48:58.192430935 -0500
@@ -8421,14 +8421,6 @@ ssl3_HandleClientHello(sslSocket *ss, SS
         goto alert_loser;
     }
 
-    /* Generate the Server Random now so it is available
-     * when we process the ClientKeyShare in TLS 1.3 */
-    rv = ssl3_GetNewRandom(&ss->ssl3.hs.server_random);
-    if (rv != SECSuccess) {
-        errCode = SSL_ERROR_GENERATE_RANDOM_FAILURE;
-        goto loser;
-    }
-
 #ifndef TLS_1_3_DRAFT_VERSION
     /*
      * [draft-ietf-tls-tls13-11 Section 6.3.1.1].
@@ -9323,7 +9315,11 @@ ssl3_SendServerHello(sslSocket *ss)
     if (rv != SECSuccess) {
         return rv; /* err set by AppendHandshake. */
     }
-    /* Random already generated in ssl3_HandleClientHello */
+
+    rv = ssl3_GetNewRandom(&ss->ssl3.hs.server_random);
+        if (rv != SECSuccess) {
+            return SECFailure;
+        }
     rv = ssl3_AppendHandshake(
         ss, &ss->ssl3.hs.server_random, SSL3_RANDOM_LENGTH);
     if (rv != SECSuccess) {
